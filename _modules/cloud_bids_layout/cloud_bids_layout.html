
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cloud_bids_layout.cloud_bids_layout &#8212; Cloud-BIDS-Layout 0.1.dev261536445 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/collapsible.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Cloud-BIDS-Layout</a></h1>



<p class="blurb">Use pybids with datasets in the cloud</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=nrdg&repo=cloud_bids_layout&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">faq</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/nrdg/cloud_bids_layout/tree/master/examples">examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/nrdg/cloud_bids_layout/blob/master/CONTRIBUTING.md">contributing</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/nrdg/cloud_bids_layout">code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/nrdg/cloud_bids_layout/issues">bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">history</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cloud_bids_layout.cloud_bids_layout</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Main module for Cloud-BIDS-Layout.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">bids</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">s3fs</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">from</span> <span class="nn">botocore</span> <span class="kn">import</span> <span class="n">UNSIGNED</span>
<span class="kn">from</span> <span class="nn">botocore.client</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CloudBIDSLayout&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_s3_client</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a boto3 s3 client</span>

<span class="sd">    Global boto clients are not thread safe so we use this function</span>
<span class="sd">    to return independent session clients for different threads.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    anon : bool, default=True</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or boto’s credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s3_client : boto3.client(&#39;s3&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">anon</span><span class="p">:</span>
        <span class="n">s3_client</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">(</span><span class="n">signature_version</span><span class="o">=</span><span class="n">UNSIGNED</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s3_client</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s3_client</span>


<span class="k">def</span> <span class="nf">_get_matching_s3_keys</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate all the matching keys in an S3 bucket.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bucket : str</span>
<span class="sd">        Name of the S3 bucket</span>

<span class="sd">    prefix : str, optional</span>
<span class="sd">        Only fetch keys that start with this prefix</span>

<span class="sd">    suffix : str, optional</span>
<span class="sd">        Only fetch keys that end with this suffix</span>

<span class="sd">    anon : bool, default=True</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or boto’s credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order)</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    key : list</span>
<span class="sd">        S3 keys that match the prefix and suffix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">_get_s3_client</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="n">anon</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span> <span class="s2">&quot;MaxKeys&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>

    <span class="c1"># If the prefix is a single string (not a tuple of strings), we can</span>
    <span class="c1"># do the filtering directly in the S3 API.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;Prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># The S3 API response is a large blob of metadata.</span>
        <span class="c1"># &#39;Contents&#39; contains information about the listed objects.</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;Contents&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">key</span>

        <span class="c1"># The S3 API is paginated, returning up to 1000 keys at a time.</span>
        <span class="c1"># Pass the continuation token into the next response, until we</span>
        <span class="c1"># reach the final page (when this field is missing).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ContinuationToken&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;NextContinuationToken&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">break</span>


<span class="k">def</span> <span class="nf">_mimic_s3</span><span class="p">(</span><span class="n">remote_location</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mimic a dataset located on Amazon S3</span>

<span class="sd">    This function downloads all json files and mimics the rest using</span>
<span class="sd">    empty files</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    remote_location : str</span>
<span class="sd">        The Amazon S3 URI</span>

<span class="sd">    download_dir : str, optional, default=None</span>
<span class="sd">        The local directory to which the study will be downloaded.</span>
<span class="sd">        All json files will be downloaded and all remaining files</span>
<span class="sd">        will be mimicked with empty files of the same name. If None,</span>
<span class="sd">        this function will use tempfile.mkdtemp() to create a</span>
<span class="sd">        temporary directory. It is the user&#39;s responsibility to</span>
<span class="sd">        delete this directory when done.</span>

<span class="sd">    anon : bool, default=True</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or boto’s credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        with keys &quot;download_dir&quot; for the host download directory</span>
<span class="sd">        and &quot;host2cloud_file_map&quot;, which is itself a dict, where</span>
<span class="sd">        the keys are the host filename and the values are the</span>
<span class="sd">        cloud locations (e.g. Amazon S3 URIs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="n">anon</span><span class="p">)</span>

    <span class="n">uri_entities</span> <span class="o">=</span> <span class="n">_parse_s3_uri</span><span class="p">(</span><span class="n">remote_location</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">uri_entities</span><span class="p">[</span><span class="s2">&quot;bucket&quot;</span><span class="p">]</span>
    <span class="n">s3_prefix</span> <span class="o">=</span> <span class="n">uri_entities</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>

    <span class="n">s3_keys</span> <span class="o">=</span> <span class="n">_get_matching_s3_keys</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">s3_prefix</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="n">anon</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">download_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">download_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

    <span class="n">host2cloud_file_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">s3_key</span> <span class="ow">in</span> <span class="n">s3_keys</span><span class="p">:</span>
        <span class="n">rel_key</span> <span class="o">=</span> <span class="n">s3_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">s3_prefix</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">rel_key</span><span class="p">))</span>

        <span class="n">complete_s3_key</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">bucket</span><span class="p">,</span> <span class="n">s3_key</span><span class="p">])</span>
        <span class="n">host2cloud_file_map</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_s3_key</span>

        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">complete_s3_key</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;download_dir&quot;</span><span class="p">:</span> <span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;host2cloud_file_map&quot;</span><span class="p">:</span> <span class="n">host2cloud_file_map</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_parse_s3_uri</span><span class="p">(</span><span class="n">s3_uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse an Amazon S3 URI into bucket and key entities</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s3_uri : str</span>
<span class="sd">        The Amazon S3 URI</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        dict with keys &quot;bucket&quot; and &quot;key&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parse s3_uri into bucket and key</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(s3:\/\/)?(?P&lt;bucket&gt;[^\/]*)\/(?P&lt;key&gt;.*)&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">s3_uri</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;s3_uri is not a valid URI. It should match the regex &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;pattern </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">. You provided </span><span class="si">{</span><span class="n">s3_uri</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>


<div class="viewcode-block" id="CloudBIDSLayout"><a class="viewcode-back" href="../../cloud_bids_layout.html#cloud_bids_layout.cloud_bids_layout.CloudBIDSLayout">[docs]</a><span class="k">class</span> <span class="nc">CloudBIDSLayout</span><span class="p">(</span><span class="n">bids</span><span class="o">.</span><span class="n">BIDSLayout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper for bids.BIDSLayout that can access BIDS studies on Amazon S3</span>

<span class="sd">    This object uses empty files to mimic the file structure of a BIDS</span>
<span class="sd">    study on Amazon S3, downloading only the json files required by</span>
<span class="sd">    pybids to parse file entities.</span>

<span class="sd">    The remaining parameters from bids.BIDSLayout are listed below to make</span>
<span class="sd">    this docstring more useful</span>

<span class="sd">    remote_location : str</span>
<span class="sd">        Location (URI) of study on Amazon S3</span>
<span class="sd">    download_dir : str, optional, default=None</span>
<span class="sd">        The local directory to which the study will be downloaded.</span>
<span class="sd">        All json files will be downloaded and all remaining files</span>
<span class="sd">        will be mimicked with empty files of the same name. If None,</span>
<span class="sd">        CloudBIDSLayout will use tempfile.mkdtemp() to create a</span>
<span class="sd">        temporary directory. It is the user&#39;s responsibility to</span>
<span class="sd">        delete this directory when done.</span>
<span class="sd">    anon : bool, default=True</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or boto’s credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config</span>
<span class="sd">        files, EC2 IAM server, in that order)</span>
<span class="sd">    validate : bool, optional</span>
<span class="sd">        If True, all files are checked for BIDS compliance</span>
<span class="sd">        when first indexed, and non-compliant files are ignored. This</span>
<span class="sd">        provides a convenient way to restrict file indexing to only those</span>
<span class="sd">        files defined in the &quot;core&quot; BIDS spec, as setting validate=True</span>
<span class="sd">        will lead files in supplementary folders like derivatives/, code/,</span>
<span class="sd">        etc. to be ignored.</span>
<span class="sd">    absolute_paths : bool, optional</span>
<span class="sd">        If True, queries always return absolute paths.</span>
<span class="sd">        If False, queries return relative paths (for files and</span>
<span class="sd">        directories).</span>
<span class="sd">    derivatives : bool or str or list, optional</span>
<span class="sd">        Specifies whether and/or which</span>
<span class="sd">        derivatives to to index. If True, all pipelines found in the</span>
<span class="sd">        derivatives/ subdirectory will be indexed. If a str or list, gives</span>
<span class="sd">        the paths to one or more derivatives directories to index. If False</span>
<span class="sd">        or None, the derivatives/ directory is ignored during indexing, and</span>
<span class="sd">        derivatives will have to be added manually via add_derivatives().</span>
<span class="sd">        Note: derivatives datasets MUST contain a dataset_description.json</span>
<span class="sd">        file in order to be indexed.</span>
<span class="sd">    config : str or list or None, optional</span>
<span class="sd">        Optional name(s) of configuration file(s) to use.</span>
<span class="sd">        By default (None), uses &#39;bids&#39;.</span>
<span class="sd">    sources : :obj:`bids.layout.BIDSLayout` or list or None, optional</span>
<span class="sd">        Optional BIDSLayout(s) from which the current BIDSLayout is derived.</span>
<span class="sd">    ignore : str or SRE_Pattern or list</span>
<span class="sd">        Path(s) to exclude from indexing. Each</span>
<span class="sd">        path is either a string or a SRE_Pattern object (i.e., compiled</span>
<span class="sd">        regular expression). If a string is passed, it must be either an</span>
<span class="sd">        absolute path, or be relative to the BIDS project root. If an</span>
<span class="sd">        SRE_Pattern is passed, the contained regular expression will be</span>
<span class="sd">        matched against the full (absolute) path of all files and</span>
<span class="sd">        directories. By default, indexing ignores all files in &#39;code/&#39;,</span>
<span class="sd">        &#39;stimuli/&#39;, &#39;sourcedata/&#39;, &#39;models/&#39;, and any hidden files/dirs</span>
<span class="sd">        beginning with &#39;.&#39; at root level.</span>
<span class="sd">    force_index : str or SRE_Pattern or list</span>
<span class="sd">        Path(s) to forcibly index in the</span>
<span class="sd">        BIDSLayout, even if they would otherwise fail validation. See the</span>
<span class="sd">        documentation for the ignore argument for input format details.</span>
<span class="sd">        Note that paths in force_index takes precedence over those in</span>
<span class="sd">        ignore (i.e., if a file matches both ignore and force_index, it</span>
<span class="sd">        *will* be indexed).</span>
<span class="sd">        Note: NEVER include &#39;derivatives&#39; here; use the derivatives argument</span>
<span class="sd">        (or :obj:`bids.layout.BIDSLayout.add_derivatives`) for that.</span>
<span class="sd">    config_filename : str</span>
<span class="sd">        Optional name of filename within directories</span>
<span class="sd">        that contains configuration information.</span>
<span class="sd">    regex_search : bool</span>
<span class="sd">        Whether to require exact matching (True) or regex</span>
<span class="sd">        search (False, default) when comparing the query string to each</span>
<span class="sd">        entity in .get() calls. This sets a default for the instance, but</span>
<span class="sd">        can be overridden in individual .get() requests.</span>
<span class="sd">    database_path : str</span>
<span class="sd">        Optional path to directory containing SQLite database file index</span>
<span class="sd">        for this BIDS dataset. If a value is passed and the folder</span>
<span class="sd">        already exists, indexing is skipped. By default (i.e., if None),</span>
<span class="sd">        an in-memory SQLite database is used, and the index will not</span>
<span class="sd">        persist unless .save() is explicitly called.</span>
<span class="sd">    reset_database : bool</span>
<span class="sd">        If True, any existing directory specified in the</span>
<span class="sd">        database_path argument is deleted, and the BIDS dataset provided</span>
<span class="sd">        in the root argument is reindexed. If False, indexing will be</span>
<span class="sd">        skipped and the existing database file will be used. Ignored if</span>
<span class="sd">        database_path is not provided.</span>
<span class="sd">    index_metadata : bool</span>
<span class="sd">        If True, all metadata files are indexed at</span>
<span class="sd">        initialization. If False, metadata will not be available (but</span>
<span class="sd">        indexing will be faster).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote_location</span><span class="p">,</span>
        <span class="n">download_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">absolute_paths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">derivatives</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">config_filename</span><span class="o">=</span><span class="s2">&quot;layout_config.json&quot;</span><span class="p">,</span>
        <span class="n">regex_search</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">database_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">database_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">reset_database</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">index_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">mimic</span> <span class="o">=</span> <span class="n">_mimic_s3</span><span class="p">(</span>
            <span class="n">remote_location</span><span class="o">=</span><span class="n">remote_location</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="n">anon</span>
        <span class="p">)</span>
        <span class="n">bids_dir</span> <span class="o">=</span> <span class="n">mimic</span><span class="p">[</span><span class="s2">&quot;download_dir&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_uri</span> <span class="o">=</span> <span class="n">remote_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_download_dir</span> <span class="o">=</span> <span class="n">bids_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host2cloud_file_map</span> <span class="o">=</span> <span class="n">mimic</span><span class="p">[</span><span class="s2">&quot;host2cloud_file_map&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anon</span> <span class="o">=</span> <span class="n">anon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_downloaded_from_cloud</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">root</span><span class="o">=</span><span class="n">bids_dir</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span>
            <span class="n">absolute_paths</span><span class="o">=</span><span class="n">absolute_paths</span><span class="p">,</span>
            <span class="n">derivatives</span><span class="o">=</span><span class="n">derivatives</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
            <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">,</span>
            <span class="n">force_index</span><span class="o">=</span><span class="n">force_index</span><span class="p">,</span>
            <span class="n">config_filename</span><span class="o">=</span><span class="n">config_filename</span><span class="p">,</span>
            <span class="n">regex_search</span><span class="o">=</span><span class="n">regex_search</span><span class="p">,</span>
            <span class="n">database_path</span><span class="o">=</span><span class="n">database_path</span><span class="p">,</span>
            <span class="n">database_file</span><span class="o">=</span><span class="n">database_file</span><span class="p">,</span>
            <span class="n">reset_database</span><span class="o">=</span><span class="n">reset_database</span><span class="p">,</span>
            <span class="n">index_metadata</span><span class="o">=</span><span class="n">index_metadata</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CloudBIDSLayout.download_files"><a class="viewcode-back" href="../../cloud_bids_layout.html#cloud_bids_layout.cloud_bids_layout.CloudBIDSLayout.download_files">[docs]</a>    <span class="k">def</span> <span class="nf">download_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">return_type</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">regex_search</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">absolute_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">invalid_filters</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">filters</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper for bids.BIDSLayout().get()</span>

<span class="sd">        Retrieves files and/or metadata from the current Layout</span>
<span class="sd">        and downloads the resulting files. The remaining</span>
<span class="sd">        parameters for bids.BIDSLayout().get are listed below to</span>
<span class="sd">        make this docstring more useful.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        return_type : str, optional</span>
<span class="sd">            Type of result to return. Valid values:</span>
<span class="sd">            &#39;object&#39; (default): return a list of matching BIDSFile objects.</span>
<span class="sd">            &#39;file&#39; or &#39;filename&#39;: return a list of matching filenames.</span>
<span class="sd">            &#39;dir&#39;: return a list of directories.</span>
<span class="sd">            &#39;id&#39;: return a list of unique IDs. Must be used together</span>
<span class="sd">                  with a valid target.</span>
<span class="sd">        target : str, optional</span>
<span class="sd">            Optional name of the target entity to get results for</span>
<span class="sd">            (only used if return_type is &#39;dir&#39; or &#39;id&#39;).</span>
<span class="sd">        scope : str or list, optional</span>
<span class="sd">            Scope of the search space. If passed, only</span>
<span class="sd">            nodes/directories that match the specified scope will be</span>
<span class="sd">            searched. Possible values include:</span>
<span class="sd">            &#39;all&#39; (default): search all available directories.</span>
<span class="sd">            &#39;derivatives&#39;: search all derivatives directories.</span>
<span class="sd">            &#39;raw&#39;: search only BIDS-Raw directories.</span>
<span class="sd">            &#39;self&#39;: search only the directly called BIDSLayout.</span>
<span class="sd">            &lt;PipelineName&gt;: the name of a BIDS-Derivatives pipeline.</span>
<span class="sd">        regex_search : bool or None, optional</span>
<span class="sd">            Whether to require exact matching</span>
<span class="sd">            (False) or regex search (True) when comparing the query string</span>
<span class="sd">            to each entity.</span>
<span class="sd">        absolute_paths : bool, optional</span>
<span class="sd">            Optionally override the instance-wide option</span>
<span class="sd">            to report either absolute or relative (to the top of the</span>
<span class="sd">            dataset) paths. If None, will fall back on the value specified</span>
<span class="sd">            at BIDSLayout initialization.</span>
<span class="sd">        invalid_filters (str): Controls behavior when named filters are</span>
<span class="sd">            encountered that don&#39;t exist in the database (e.g., in the case of</span>
<span class="sd">            a typo like subbject=&#39;0.1&#39;). Valid values:</span>
<span class="sd">                &#39;error&#39; (default): Raise an explicit error.</span>
<span class="sd">                &#39;drop&#39;: Silently drop invalid filters (equivalent to not having</span>
<span class="sd">                    passed them as arguments in the first place).</span>
<span class="sd">                &#39;allow&#39;: Include the invalid filters in the query, resulting</span>
<span class="sd">                    in no results being returned.</span>
<span class="sd">        filters : dict</span>
<span class="sd">            Any optional key/values to filter the entities on.</span>
<span class="sd">            Keys are entity names, values are regexes to filter on. For</span>
<span class="sd">            example, passing filters={&#39;subject&#39;: &#39;sub-[12]&#39;} would return</span>
<span class="sd">            only files that match the first two subjects. In addition to</span>
<span class="sd">            ordinary data types, the following enums are defined (in the</span>
<span class="sd">            Query class):</span>
<span class="sd">                * Query.NONE: The named entity must not be defined.</span>
<span class="sd">                * Query.ANY: the named entity must be defined, but can have any</span>
<span class="sd">                    value.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of :obj:`bids.layout.BIDSFile` or str</span>
<span class="sd">            A list of BIDSFiles (default) or strings (see return_type).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_return_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_return_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;return_type must be one of </span><span class="si">{</span><span class="n">valid_return_types</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">return_type</span><span class="o">=</span><span class="n">return_type</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span>
            <span class="n">regex_search</span><span class="o">=</span><span class="n">regex_search</span><span class="p">,</span>
            <span class="n">absolute_paths</span><span class="o">=</span><span class="n">absolute_paths</span><span class="p">,</span>
            <span class="n">invalid_filters</span><span class="o">=</span><span class="n">invalid_filters</span><span class="p">,</span>
            <span class="o">**</span><span class="n">filters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">return_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">):</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_anon</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">s3_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host2cloud_file_map</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname</span><span class="p">)]</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s3_key</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    
    <div class="footer">
      &copy;2020, Adam Richie-Halford.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
    <script type="text/javascript">
        $(document).ready(function() {
            $(".toggle > *").hide();
            $(".toggle .header").show();
            $(".toggle .header").click(function() {
                $(this).parent().children().not(".header").toggle(400);
                $(this).parent().children(".header").toggleClass("open");
            })
        });
    </script>

  </body>
</html>